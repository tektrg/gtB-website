import fs from "node:fs";
import path from "node:path";

const root = process.cwd();
const topicBankPath = path.join(root, "AUTONOMUS", "content", "topic-bank.json");
const researchDir = path.join(root, "AUTONOMUS", "research", "blog");

function parseArgs(argv) {
  const args = { topicId: null, force: false };
  for (let i = 2; i < argv.length; i++) {
    const a = argv[i];
    if (a === "--topic" || a === "--topicId") args.topicId = argv[++i];
    else if (a === "--force") args.force = true;
    else throw new Error(`Unknown arg: ${a}`);
  }
  if (!args.topicId) throw new Error("Missing --topic <topicId>");
  return args;
}

const moneyPages = [
  "/pricing",
  "/youtube-summary",
  "/privacy-first",
  "/guide/getting-started/",
  "/ai-model-cost-calculator-and-price-comparation",
];

function loadTopic(topicId) {
  if (!fs.existsSync(topicBankPath)) throw new Error(`Missing: ${topicBankPath}`);
  const bank = JSON.parse(fs.readFileSync(topicBankPath, "utf8"));
  const topics = bank.topics || [];
  const t = topics.find((x) => x.id === topicId);
  if (!t) throw new Error(`Unknown topic id: ${topicId}`);
  return t;
}

function suggestQueries(topic) {
  const title = topic.title;
  return [
    `reddit ${title}`,
    `site:reddit.com ${title}`,
    `youtube summarizer timestamps reddit`,
    `best youtube summarizer chrome extension reddit`,
    `site:reddit.com youtube transcript summarize`,
  ];
}

function template(topic) {
  const lines = [];
  lines.push(`# Research — ${topic.id}`);
  lines.push("");
  lines.push("## Target");
  lines.push("");
  lines.push(`- title: ${topic.title}`);
  if (topic.pillar) lines.push(`- pillar: ${topic.pillar}`);
  if (topic.intent) lines.push(`- intent: ${topic.intent}`);
  lines.push(`- publishFile: src/content/blog/<slug>.md (generated by AUTONOMUS)`);
  lines.push("");

  lines.push("## User discussion research");
  lines.push("");
  lines.push("### Source links (add 3–8)" );
  lines.push("");
  lines.push("- <https://www.reddit.com/...>" );
  lines.push("");
  lines.push("### Notes (quotes/snippets)");
  lines.push("");
  lines.push("- ..." );
  lines.push("");
  lines.push("### Pain points" );
  lines.push("");
  lines.push("- ..." );
  lines.push("");

  lines.push("## Keywords (10)" );
  lines.push("");
  for (let i = 1; i <= 10; i++) lines.push(`${i}. `);
  lines.push("");

  lines.push("## Backlinks" );
  lines.push("");
  lines.push("### Internal (money pages + related)" );
  lines.push("");
  for (const p of moneyPages) lines.push(`- ${p}`);
  lines.push("");
  lines.push("### External (optional)" );
  lines.push("");
  lines.push("- <https://...>" );
  lines.push("");

  lines.push("## Article angle" );
  lines.push("");
  lines.push("- 1–2 sentences describing the promise + who it’s for." );
  lines.push("" );

  lines.push("## Outline" );
  lines.push("");
  lines.push("- H2: ..." );
  lines.push("- H2: ..." );
  lines.push("- H2: ..." );
  lines.push("");

  lines.push("## GPT Breeze tie-in (must be concrete)" );
  lines.push("");
  lines.push("- Which product workflow demo is relevant (YouTube timestamps / transcript / page summary with citations / text toolbar / BYOK provider switching)." );
  lines.push("- Where the CTA link belongs (avoid spam; 1–2 placements)." );
  lines.push("");

  return lines.join("\n");
}

const args = parseArgs(process.argv);
const topic = loadTopic(args.topicId);
fs.mkdirSync(researchDir, { recursive: true });

const outPath = path.join(researchDir, `${topic.id}.md`);
if (fs.existsSync(outPath) && !args.force) {
  console.log(`Exists: ${path.relative(root, outPath)} (use --force to overwrite)`);
  process.exit(0);
}

fs.writeFileSync(outPath, template(topic), "utf8");

console.log(`Wrote: ${path.relative(root, outPath)}`);
console.log("Suggested search queries:");
for (const q of suggestQueries(topic)) console.log(`- ${q}`);
